name: æ—¥æœ¬æ ªåˆ†æãƒœãƒƒãƒˆ

on:
  schedule:
    # æ±è¨¼å–å¼•æ™‚é–“ä¸­ã«5åˆ†é–“éš”ã§å®Ÿè¡Œï¼ˆUTC = JST - 9æ™‚é–“ï¼‰
    # å‰å ´: JST 9:00-11:30 = UTC 0:00-2:30
    # å¾Œå ´: JST 12:30-15:00 = UTC 3:30-6:00
    # æ±è¨¼å–å¼•æ™‚é–“ä¸­ï¼ˆæœˆã€œé‡‘ã€UTC 0:00-7:00 = JST 9:00-16:00ï¼‰: 5åˆ†é–“éš”
    # æ±è¨¼å–å¼•æ™‚é–“ä¸­ï¼ˆæœˆã€œé‡‘ã€UTC 0:00-7:00 = JST 9:00-16:00ï¼‰: 5åˆ†é–“éš”
    # å®Œå…¨ã«å¸‚å ´æ™‚é–“å†…ã®ã¿ï¼ˆ0:00-6:00 UTC = 9:00-15:00 JSTï¼‰
    - cron: '*/5 0-6 * * 1-5'

  # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«ã‚‚å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  push:
    branches:
      - main


  workflow_dispatch:
    inputs:
      mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'analysis'
        type: choice
        options:
          - analysis
          - summary

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt pytz

      - name: Restore portfolio state
        continue-on-error: true
        run: |
          git pull origin main --rebase || true

      - name: Run analysis
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ "${{ github.event.inputs.mode }}" = "summary" ]; then
            python main.py --summary
          else
            if [ "${{ github.event_name }}" = "push" ]; then
              python main.py --force
            else
              python main.py
            fi
          fi

      - name: Save state
        continue-on-error: true
        run: |
          git config user.name "Stock Bot"
          git config user.email "bot@stock-analyzer.local"
          git add -A portfolio.json signal_history.json processed_messages.json 2>/dev/null || true
          git diff --staged --quiet || git commit -m "ğŸ“Š åˆ†æå®Ÿè¡Œ $(date -u +%Y-%m-%dT%H:%M:%S)"
          git push || true
